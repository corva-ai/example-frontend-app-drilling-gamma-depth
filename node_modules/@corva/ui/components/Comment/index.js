import e from"@babel/runtime/helpers/defineProperty";import t from"moment";import{noop as r,get as n}from"lodash";import o from"@babel/runtime/helpers/classCallCheck";import i from"@babel/runtime/regenerator";import a from"@babel/runtime/helpers/asyncToGenerator";import s from"@material-ui/core/colors/grey";import c from"../../utils/main.js";import{isNativeDetected as m}from"../../utils/mobileDetect.js";import l from"@babel/runtime/helpers/createClass";import{jsxs as p,jsx as u}from"react/jsx-runtime";import{createRef as d,PureComponent as h}from"react";import{deleteFeedItemComment as f}from"../../clients/jsonApi/index.js";import g from"prop-types";import y from"classnames";import{withStyles as v}from"@material-ui/core/styles";import b from"@babel/runtime/helpers/assertThisInitialized";import C from"@babel/runtime/helpers/inherits";import D from"@babel/runtime/helpers/possibleConstructorReturn";import M from"@babel/runtime/helpers/getPrototypeOf";import E from"@material-ui/core/Typography";import w from"../ConfirmationDialog.js";import I from"../Avatar/index.js";import O from"../UserCardPopover.js";import{formatMentionText as j}from"../UserMention/utils/index.js";import{isUserAdmin as k,isUserCorvaAdmin as x}from"../../utils/user.js";import A from"@material-ui/core/IconButton";import N from"@material-ui/icons/MoreVert";import S from"../Attachment/index.js";import _ from"../CommentInput/index.js";import R from"../CommentWrapper.js";import P from"../CommentLoader.js";import T from"@material-ui/core/Menu";import U from"@material-ui/core/MenuItem";import z from"./styles.css.js";function L(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function W(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=M(e);if(t){var o=M(this).constructor;r=Reflect.construct(n,arguments,o)}else r=n.apply(this,arguments);return D(this,r)}}var B={chatAvatarWrapper:{paddingTop:2,position:"absolute",top:6,left:-18},commentInfoContainer:{display:"inline-flex",alignItems:"center",width:"100%",paddingTop:5},userNameWrapper:{overflow:"hidden"},infoContainer:{display:"inline-block",verticalAlign:"top",width:"100%",paddingLeft:10}},q={commentWrapper:{width:"calc(100% - 10px)"},timeRoot:{color:s[700],float:"right",marginRight:5,marginLeft:10,fontSize:"10px"},textRoot:{marginTop:5,color:"#CCC",fontWeight:"normal",fontSize:"14px"},iconButtonRoot:{float:"right",height:40,width:40,padding:0,visibility:"hidden"},userName:{fontSize:"12px"}},F=function(m){C(v,h);var g=W(v);function v(t){var r,n;return o(this,v),r=g.call(this,t),e(b(r),"deleteComment",(n=a(i.mark((function e(t,r){var n;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,f(t,r);case 3:n=e.sent,e.next=9;break;case 6:e.prev=6,e.t0=e.catch(0),console.error(e.t0);case 9:return e.abrupt("return",n);case 10:case"end":return e.stop()}}),e,null,[[0,6]])}))),function(e,t){return n.apply(this,arguments)})),e(b(r),"showIntoView",(function(){r.props.handleShowOnMount(),r.commentEl.current.scrollIntoView({block:"end"})})),e(b(r),"handleToggleActionsMenu",(function(e){var t=e.currentTarget;r.setState((function(e){return{actionsMenuAnchorEl:e.actionsMenuAnchorEl?null:t}}))})),e(b(r),"handleKeyDown",(function(e){27===e.keyCode&&r.setState({isEditing:!1}),document.removeEventListener("keydown",r.handleKeyDown,!1)})),e(b(r),"handleEditMenuItem",(function(){document.addEventListener("keydown",r.handleKeyDown,!1),r.setState({isEditing:!0},(function(){r.inputEl.current&&r.inputEl.current.focus()}))})),e(b(r),"getEditCommentProps",(function(){var e=r.props.comment,t=e.id,n=e.body,o=e.attachment;return{editFeedItemId:e.feed_activity_id,editCommentId:t,editComment:n,editAttachment:o}})),e(b(r),"onEditFinish",(function(){r.setState({isEditing:!1,isLoading:!1})})),e(b(r),"handleDeleteMenuItem",(function(){r.setState({openDeleteDialog:!0})})),e(b(r),"handleDelete",a(i.mark((function e(){var t,n,o;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=r.props.comment.id,n=r.props.comment.feed_activity_id,r.setState({isLoading:!0}),e.next=5,r.deleteComment(n,t);case 5:o=e.sent,r.setState({isLoading:!1,openDeleteDialog:!1}),o&&r.props.handleDeleteCallback(t);case 8:case"end":return e.stop()}}),e)})))),r.state={actionsMenuAnchorEl:null,isLoading:!1,isEditing:!1,openDeleteDialog:!1},r.inputEl=d(),r.commentEl=d(),r}return l(v,[{key:"componentDidMount",value:function(){this.props.showOnMount&&this.showIntoView()}},{key:"renderMenuIcon",value:function(){var e=this.isCurrentUserCommentCreator,t=this.isCurrentUserCommentCreator||k(this.props.user)||x(this.props.user);return t||e?p("div",{className:z.cCommentMenu,children:[u(A,{"data-testid":"".concat("comment","_menuButton"),"aria-label":"Actions","aria-owns":this.state.actionsMenuAnchorEl?"c-comment__actions-menu":void 0,"aria-haspopup":"true",classes:{root:this.props.classes.iconButtonRoot},onClick:this.handleToggleActionsMenu,children:u(N,{htmlColor:s[400]})}),p(T,{id:"c-comment__actions-menu",anchorOrigin:{vertical:"top",horizontal:"right"},transformOrigin:{vertical:"top",horizontal:"right"},anchorEl:this.state.actionsMenuAnchorEl,open:!!this.state.actionsMenuAnchorEl,onClick:this.handleToggleActionsMenu,children:[e&&u(U,{"data-testid":"".concat("comment","_editMenuItem"),onClick:this.handleEditMenuItem,children:"Edit"}),t&&u(U,{"data-testid":"".concat("comment","_deleteMenuItem"),onClick:this.handleDeleteMenuItem,children:"Delete"})]})]}):null}},{key:"render",value:function(){var o=this,i=this.state,a=i.isLoading,s=i.isEditing;if(a){var m=this.props.spaceAround;return u(P,{spaceAround:m})}var l=this.props,d=l.comment,h=l.classes,f=l.spaceAround,g=l.isNative,v=l.patchCommentCallback,b=l.companyId;if(s)return u(_,function(t){for(var r=1;r<arguments.length;r++){var n=null!=arguments[r]?arguments[r]:{};r%2?L(Object(n),!0).forEach((function(r){e(t,r,n[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):L(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}({inputRef:this.inputEl,postComment:r,exitEditMode:this.onEditFinish,setIsEditting:function(){return o.setState({isLoading:!0})},patchCommentCallback:v,companyId:b},this.getEditCommentProps()));var C=c.getUserFullName(d.user),D=g?"MM/DD HH:mm":"MM/DD/YY HH:mm",M=t(d.created_at).format(D),k=n(d,["attachment","url"]),x=n(d,["attachment","size"]);return p("div",{"data-testid":"".concat("comment","_commentItem_").concat(d.body),className:y(z.cComment,e({},z.cCommentNative,g)),ref:this.commentEl,children:[p(R,{spaceAround:f,className:this.props.classes.commentWrapper,children:[u("div",{style:B.chatAvatarWrapper,children:g?u(I,{size:26,displayName:C,imgSrc:n(d,["user","profile_photo"]),className:this.props.classes.avatar}):u(O,{user:d.user,currentUser:this.props.currentUser,children:u(I,{size:26,displayName:C,imgSrc:n(d,["user","profile_photo"]),className:this.props.classes.avatar})})}),p("div",{style:B.infoContainer,children:[u("div",{children:p("div",{style:B.commentInfoContainer,children:[u("div",{style:B.userNameWrapper,children:u(E,{"data-testid":"".concat("comment","_userName"),variant:"subtitle2",noWrap:!0,className:h.userName,children:C})}),u("div",{style:B.timeWrapper,children:u(E,{"data-testid":"".concat("comment","_addTime"),variant:"caption",classes:{root:h.timeRoot},children:M})})]})}),p("div",{className:z.cCommentBody,children:[this.renderMenuIcon(),u(E,{"data-testid":"".concat("comment","_commentMessage"),variant:"body1",classes:{root:h.textRoot},children:j(d.body,d.mentioned_users,g,"#00bcd4",this.props.currentUser)}),k&&u(S,{attachmentUrl:k,attachmentSize:x,size:"small"})]})]})]}),this.state.openDeleteDialog&&u(w,{open:this.state.openDeleteDialog,text:"Do you really want to delete comment?",handleClose:function(){return o.setState({openDeleteDialog:!1})},handleOk:this.handleDelete,okText:"Delete"})]})}},{key:"isCurrentUserCommentCreator",get:function(){return Number(n(this.props.comment,["user","id"]))===Number(this.props.currentUser.id)}}]),v}();F.propTypes={comment:g.shape({}).isRequired,showOnMount:g.bool,spaceAround:g.bool,handleShowOnMount:g.func,handleEdit:g.func,handleDeleteCallback:g.func.isRequired,patchCommentCallback:g.func.isRequired,companyId:g.number,currentUser:g.shape(),classes:g.shape({}).isRequired,isNative:g.bool},F.defaultProps={showOnMount:!1,spaceAround:!1,handleShowOnMount:r,handleEdit:r,companyId:null,isNative:m,currentUser:{}};var H=v(q)(F);export default H;
