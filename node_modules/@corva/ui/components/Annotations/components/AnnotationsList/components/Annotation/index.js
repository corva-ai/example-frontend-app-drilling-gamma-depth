import t from"@babel/runtime/helpers/defineProperty";import e from"moment";import{flowRight as n}from"lodash";import i from"@babel/runtime/helpers/slicedToArray";import r from"@babel/runtime/regenerator";import a from"@babel/runtime/helpers/asyncToGenerator";import o from"@material-ui/core/colors/grey";import{jsx as s,jsxs as c,Fragment as d}from"react/jsx-runtime";import{IconButton as m,Menu as l,MenuItem as u,Paper as p,Typography as h,Divider as f}from"@material-ui/core";import{useState as v}from"react";import{deleteAnnotation as C,patchAnnotation as _}from"../../../../../../clients/jsonApi/index.js";import{shape as b,number as A,string as y,bool as R,oneOf as g,node as N,func as q,arrayOf as x}from"prop-types";import k from"classnames";import{withStyles as M}from"@material-ui/core/styles";import I from"../../../../../ConfirmationDialog.js";import T from"../../../../../Avatar/index.js";import{DELETE_ANNOTATION as j,EDIT_ANNOTATION as w}from"../../../../constants.js";import{useAnnotationsDispatch as D}from"../../../../AnnotationsContext.js";import U from"../../../../../UserCardPopover.js";import{formatMentionText as E}from"../../../../../UserMention/utils/index.js";import S from"../AnnotationInput/index.js";import O,{isWidthUp as z}from"@material-ui/core/withWidth";import B from"@material-ui/icons/MoreVert";import P from"../../../../../CommentsInfo/index.js";import L from"../../../../../Attachment/index.js";import W from"../AnnotationComments/index.js";import Y from"./style.css.js";var G="AppAnnotationItemPo",H=function(t){var e=t.user,n=t.currentUser,i=t.isNative,r=t.classes;return s("div",{className:Y.cAnnotationUserAvatar,children:i?s(T,{displayName:"".concat(e.first_name," ").concat(e.last_name),imgSrc:e.profile_photo,size:38,className:r.avatar}):s(U,{user:e,currentUser:n,children:s(T,{displayName:"".concat(e.first_name," ").concat(e.last_name),imgSrc:e.profile_photo,size:38,className:r.avatar})})})},V=function(t){var e=t.actionsMenuAnchorEl,n=t.handleToggleActionsMenu,i=t.classes,r=t.handleEdit,a=t.handleDelete;return c(d,{children:[s(m,{"data-testid":"".concat(G,"_menuButton"),"aria-label":"Actions","aria-owns":e?Y.cAnnotationContainerActionsMenu:void 0,"aria-haspopup":"true",className:i.iconButtonRoot,onClick:n,children:s(B,{htmlColor:o[400]})}),c(l,{id:"cAnnotationContainerActionsMenu",anchorOrigin:{vertical:"top",horizontal:"right"},transformOrigin:{vertical:"top",horizontal:"right"},anchorEl:e,open:!!e,onClick:n,children:[s(u,{"data-testid":"".concat(G,"_editMenuItem"),onClick:r,children:"Edit"}),s(u,{"data-testid":"".concat(G,"_deleteMenuItem"),onClick:a,children:"Delete"})]})]})},F=function(n){var o,m,l=n.included,u=n.annotation,b=n.assetCompanyId,A=n.classes,y=n.isNative,R=n.showSuccessNotification,g=n.width,N=v(!1),q=i(N,2),x=q[0],M=q[1],T=v(null),U=i(T,2),O=U[0],B=U[1],F=v(!1),J=i(F,2),K=J[0],Q=J[1],X=v(!1),Z=i(X,2),$=Z[0],tt=Z[1],et=!z("sm",g),nt=u.attributes.comments_count||0,it=v(nt),rt=i(it,2),at=rt[0],ot=rt[1],st=D(),ct=u.relationships.comment_users.data.reduce((function(t,e){var n=e.id,i=l.find((function(t){return t.id===n}));return i&&t.push(i.attributes),t}),[]),dt=ct.map((function(t){var e=t.last_name,n=t.first_name;return"".concat(n," ").concat(e)})),mt=(o=a(r.mark((function t(){return r.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,C(u.id);case 3:t.sent&&st({type:j,id:u.id}),t.next=10;break;case 7:t.prev=7,t.t0=t.catch(0),console.error(t.t0);case 10:case"end":return t.stop()}}),t,null,[[0,7]])}))),function(){return o.apply(this,arguments)}),lt=(m=a(r.mark((function t(e,n,i){var a,o;return r.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,a={body:e,active_until:n,attachment:{file_name:i&&i.attachmentName,s3_link:i&&i.attachmentUrl}},t.next=4,_(u.id,a);case 4:o=t.sent,st({type:w,annotation:o,id:u.id}),t.next=12;break;case 8:return t.prev=8,t.t0=t.catch(0),console.error(t.t0),t.abrupt("return");case 12:R("Annotation has been changed"),Q(!1);case 14:case"end":return t.stop()}}),t,null,[[0,8]])}))),function(t,e,n){return m.apply(this,arguments)}),ut=u.relationships.user.data.id,pt=l.find((function(t){var e=t.type,n=t.id;return"user"===e&&n===ut})),ht=pt.attributes,ft=u.attributes.attachment;return c(p,{className:A.container,elevation:0,children:[c("div",{"data-testid":"".concat(G,"_annotation_").concat(u.attributes.body),className:Y.cAnnotationContainer,children:[s(H,{user:ht,classes:A,isNative:y,currentUser:pt}),c("div",{className:Y.cAnnotationContainerTop,children:[c("div",{className:Y.cAnnotationContainerTopMainInfo,children:[s(h,{variant:"body2","data-testid":"".concat(G,"_userName"),children:"".concat(ht.first_name," ").concat(ht.last_name)}),s(h,{"data-testid":"".concat(G,"_addDate"),variant:"caption",className:A.createdAt,children:e(u.attributes.created_at).format("MM/DD/YY H:mm")})]}),s("div",{className:k(Y.cAnnotationContainerTopMenu,t({},Y.cAnnotationContainerTopMenuSmall,et)),children:s(V,{actionsMenuAnchorEl:O,handleToggleActionsMenu:function(t){var e=t.currentTarget;B(O?null:e)},handleEdit:function(){return Q(!0)},handleDelete:function(){return tt(!0)},classes:A})})]}),s(f,{className:A.headerDividerRoot}),s("div",{"data-testid":"".concat(G,"_message"),className:Y.cAnnotationContainerContent,children:K?s(S,{initialText:u.attributes.body,assetCompanyId:b,initialPeriod:u.attributes.created_at,initialAttachment:ft,onSend:lt,onClose:function(){return Q(!1)},closeOnEsc:!0}):c(d,{children:[E(u.attributes.body,u.relationships.mentioned_users.data,y,null,pt),ft&&ft.s3_link&&s(L,{attachmentUrl:ft.s3_link,size:"small"})]})})]}),c("div",{"data-testid":"".concat(G,"_comments_").concat(u.attributes.body),className:Y.cAnnotationComments,children:[c("div",{className:Y.cAnnotationCommentsInfo,children:[s(h,{"data-testid":"".concat(G,"_commentButton"),variant:"caption",color:"primary",className:A.link,onClick:function(){return M(!0)},children:"Comment"}),s(P,{commentsCount:at,usersWhoCommented:dt,activeUsersList:ct,currentUser:pt,small:!0})]}),s(W,{annotationId:u.id,commentInputIsOpen:x,setCommentInputIsOpen:M,commentsCount:at,initialCommentsCount:nt,assetCompanyId:b,setCommentsCount:ot,currentUser:pt})]}),$&&s(I,{open:$,text:"Do you really want to delete annotation?",handleClose:function(){return tt(!1)},handleOk:mt,okText:"Delete"})]})};H.propTypes={user:b({id:A.isRequired,first_name:y.isRequired,last_name:y.isRequired,profile_photo:y.isRequired}).isRequired,currentUser:b({}).isRequired,classes:b({}).isRequired,isNative:R.isRequired},V.propTypes={actionsMenuAnchorEl:g([N,null]).isRequired,handleToggleActionsMenu:q.isRequired,classes:b({}).isRequired,handleDelete:q.isRequired,handleEdit:q.isRequired},F.propTypes={included:x(b({})).isRequired,annotation:b({relationships:b({user:b({data:b({id:y.isRequired}).isRequired}).isRequired,mentioned_users:b({data:x(b({})).isRequired}).isRequired}).isRequired,attributes:b({body:y.isRequired,created_at:y.isRequired})}).isRequired,classes:b({}).isRequired,isNative:R,showSuccessNotification:q,width:y.isRequired,assetCompanyId:A.isRequired},F.defaultProps={showSuccessNotification:function(){}};var J=n([M((function(t){return{container:{backgroundColor:"#3b3b3be6",marginBottom:16,marginLeft:26},headerDividerRoot:{margin:"10px 0"},createdAt:{color:t.palette.grey[700],marginLeft:5},link:{cursor:"pointer"},iconButtonRoot:{height:24,width:24,padding:0,margin:"0 -10px 0 5px"}}})),O()])(F);export default J;
