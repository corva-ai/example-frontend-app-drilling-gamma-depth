import e from"@babel/runtime/helpers/defineProperty";import{isNull as t,noop as n,range as r,get as a,isEmpty as i,last as l}from"lodash";import{jsxs as o,Fragment as c,jsx as s}from"react/jsx-runtime";import{makeStyles as d,Dialog as u,DialogTitle as g,DialogContent as p,Grid as f,FormControl as S,InputLabel as h,Select as m,MenuItem as E,Checkbox as b,ListItemText as v,Typography as C,FormLabel as D,RadioGroup as O,FormControlLabel as T,Radio as L,DialogActions as y,Button as _}from"@material-ui/core";import{useEffect as W}from"react";import{getAppStorage as w}from"../../clients/jsonApi/index.js";import{func as j,shape as N,number as I,string as P,oneOf as x}from"prop-types";import A from"use-tiny-state-machine";import k from"./OffsetAssetChip.js";function G(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function q(t){for(var n=1;n<arguments.length;n++){var r=null!=arguments[n]?arguments[n]:{};n%2?G(Object(r),!0).forEach((function(n){e(t,n,r[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):G(Object(r)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))}))}return t}var F=d({dialogPaper:{width:"75%",maxWidth:420}});var H={id:"stages",initial:"idle",context:{lastStageNumber:null,error:null},states:{idle:{on:{FETCH_STAGES:{target:"pending",action:function(e,t){var n=e.dispatch;w("corva","completion.wits",t,{limit:1,sort:"{timestamp:-1}"}).then((function(e){return i(e)?null:a(l(e),"stage_number",null)})).then((function(e){return n("SUCCESS",e)})).catch((function(e){throw new Error(e.message)}))}}}},pending:{on:{SUCCESS:{target:"success",beforeStateChange:function(e,t){return(0,e.updateContext)((function(e){return q(q({},e),{},{lastStageNumber:t})}))}},FAILURE:{target:"failure",beforeStateChange:function(e,t){throw new Error(t.message)}}}}}},R=function(i){var l,d,w,j,N=i.onSave,I=i.onDelete,P=i.offset,x=F(),G=A(H),R=G.state,U=G.dispatch,Y=G.context,B=A((d=(l=P).stages,w=void 0===d?{}:d,{id:"dialog",initial:"closed",context:{selectedStages:void 0===(j=l.selectedStages)?[]:j,stagesData:w},states:{closed:{on:{OPEN_DIALOG:{target:"open"}}},open:{on:{CLOSE_DIALOG:{target:"closed"},SET_SELECTED_STAGES:{target:"open",beforeStateChange:function(t,n){return(0,t.updateContext)((function(t){return q(q({},t),{},{selectedStages:n,stagesData:n.reduce((function(t,n){return q(q({},t),{},e({},n,{lineStyle:"dotted",lineWidth:2}))}),{})})}))}},SET_SELECTED_LINE_STYLE:{target:"open",beforeStateChange:function(t,n){var r=t.updateContext,a=n.stage,i=n.selectedLineStyle;return r((function(t){return q(q({},t),{},{stagesData:q(q({},t.stagesData),{},e({},a,q(q({},t.stagesData[a]),{},{lineStyle:i})))})}))}},SET_SELECTED_LINE_WIDTH:{target:"open",beforeStateChange:function(t,n){var r=t.updateContext,a=n.stage,i=n.selectedLineWidth;return r((function(t){return q(q({},t),{},{stagesData:q(q({},t.stagesData),{},e({},a,q(q({},t.stagesData[a]),{},{lineWidth:Number(i)})))})}))}}}}}})),V=B.state,z=B.dispatch,J=B.context,K=function(e){return function(t){return z("SET_SELECTED_LINE_STYLE",{stage:e,selectedLineStyle:t.target.value})}},M=function(e){return function(t){return z("SET_SELECTED_LINE_WIDTH",{stage:e,selectedLineWidth:t.target.value})}},Q=function(){return z("CLOSE_DIALOG")},X=P.selectedWellId;W((function(){U("FETCH_STAGES",X)}),[]);var Z=t(Y.lastStageNumber);return o(c,{children:[s(k,{handleDelete:I,handleClick:Z?n:function(){return z("OPEN_DIALOG")},disabled:Z,tooltipText:"Edit stages for ".concat(P.selectedWellName),children:P.selectedWellName},P.selectedWellId),"success"===R&&o(u,{open:"open"===V,onBackdropClick:Q,classes:{paper:x.dialogPaper},children:[s(g,{children:"Offset Well Stages"}),s(p,{children:o(f,{container:!0,direction:"column",spacing:16,children:[s(f,{item:!0,children:o(S,{margin:"normal",fullWidth:!0,required:!0,children:[s(h,{htmlFor:"stages-multi-select",children:"Stages"}),s(m,{inputProps:{name:"stages",id:"stages-multi-select"},value:J.selectedStages,renderValue:function(e){return"".concat(e.length," stages selected")},onChange:function(e){return z("SET_SELECTED_STAGES",e.target.value)},multiple:!0,children:r(1,Y.lastStageNumber+1).map((function(e){return o(E,{value:e,children:[s(b,{checked:J.selectedStages.includes(e)}),s(v,{primary:e})]},e)}))})]})}),J.selectedStages.sort((function(e,t){return e-t})).map((function(e){return o(f,{item:!0,children:[o(C,{variant:"subtitle1",children:["Stage ",e]}),o(S,{component:"fieldset",children:[s(D,{component:"legend",required:!0,children:"Line Style"}),o(O,{name:"line-style",value:a(J,["stagesData",e,"lineStyle"],"dotted"),onChange:K(e),row:!0,children:[s(T,{value:"dotted",control:s(L,{}),label:"Dotted"}),s(T,{value:"dashed",control:s(L,{}),label:"Dashed"}),s(T,{value:"solid",control:s(L,{}),label:"Solid"})]})]}),o(S,{component:"fieldset",children:[s(D,{component:"legend",required:!0,children:"Line Width"}),o(O,{name:"line-width",value:String(a(J,["stagesData",e,"lineWidth"],"2")),onChange:M(e),row:!0,children:[s(T,{value:String(1),control:s(L,{}),label:"Thin"}),s(T,{value:String(2),control:s(L,{}),label:"Normal"}),s(T,{value:String(4),control:s(L,{}),label:"Thick"})]})]})]},e)}))]})}),o(y,{children:[s(_,{onClick:Q,children:"Cancel"}),s(_,{variant:"contained",color:"primary",onClick:function(){var e=q(q({},P),{},{stages:J.stagesData,selectedStages:J.selectedStages});Q(),N(e)},children:"Save"})]})]})]})};R.propTypes={onSave:j.isRequired,onDelete:j.isRequired,offset:N({selectedWellId:I,selectedWellName:P,selectedWellStatus:x(["active","idle","complete","paused","unknown"])}).isRequired};export default R;
