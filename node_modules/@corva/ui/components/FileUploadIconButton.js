import e from"@babel/runtime/helpers/defineProperty";import r from"@babel/runtime/helpers/classCallCheck";import t from"@babel/runtime/regenerator";import i from"@babel/runtime/helpers/asyncToGenerator";import o from"../utils/main.js";import{isNativeDetected as l}from"../utils/mobileDetect.js";import n from"@babel/runtime/helpers/createClass";import{jsxs as s,jsx as a,Fragment as p}from"react/jsx-runtime";import{createRef as u,PureComponent as d}from"react";import{getS3SignedUrl as c}from"../clients/jsonApi/index.js";import f from"prop-types";import{withStyles as m}from"@material-ui/core/styles";import h from"@babel/runtime/helpers/assertThisInitialized";import b from"@babel/runtime/helpers/inherits";import g from"@babel/runtime/helpers/possibleConstructorReturn";import F from"@babel/runtime/helpers/getPrototypeOf";import v from"@material-ui/core/IconButton";import U from"react-s3-uploader/s3upload";import y from"@material-ui/core/CircularProgress";import S from"@material-ui/icons/PhotoCamera";import P from"./PostPreviewDialog/index.js";import O from"./Icons/AttachIcon.js";function w(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);r&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),t.push.apply(t,i)}return t}function D(r){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?w(Object(i),!0).forEach((function(t){e(r,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(i)):w(Object(i)).forEach((function(e){Object.defineProperty(r,e,Object.getOwnPropertyDescriptor(i,e))}))}return r}function j(e){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var t,i=F(e);if(r){var o=F(this).constructor;t=Reflect.construct(i,arguments,o)}else t=i.apply(this,arguments);return g(this,t)}}var C=function(l){b(m,d);var f=j(m);function m(l){var n,s;return r(this,m),n=f.call(this,l),e(h(n),"onFinish",(function(){n.setState({currentUpload:null,uploadingFileToS3:!1,openFileUploadPreviewDialog:n.props.openPreviewDialogOnUpload},(function(){n.props.onFinish&&n.props.onFinish(n.state.s3FileUrl,n.state.s3FileName,n.state.s3FileSize)}))})),e(h(n),"onError",(function(e){n.props.onError&&n.props.onError(e),console.error(e)})),e(h(n),"getSignedUrl",(s=i(t.mark((function e(r,i){var l;return t.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,c(r.name,r.type);case 3:l=e.sent,e.next=10;break;case 6:return e.prev=6,e.t0=e.catch(0),n.setState({uploadingFileToS3:null,currentUpload:null},(function(){n.onError(e.t0.message)})),e.abrupt("return");case 10:n.setState({s3FileUrl:o.getS3FileUrl(l.bucket,l.file_name),s3FileName:l.display_name,s3FileSize:r.size}),i(D(D({},l),{},{signedUrl:l.signed_url}));case 12:case"end":return e.stop()}}),e,null,[[0,6]])}))),function(e,r){return s.apply(this,arguments)})),e(h(n),"preprocess",(function(e,r){r(e)})),e(h(n),"uploadFile",(function(e){if(e.target.files[0]){n.clearUpload();var r=new U({fileElement:n.fileInput.current,getSignedUrl:n.getSignedUrl,preprocess:n.preprocess,onProgress:function(){},onFinishS3Put:n.onFinish,onError:n.onError});n.setState({uploadingFileToS3:!0,currentUpload:{uploader:r}})}})),e(h(n),"handleCloseFileUploadPreviewDialog",(function(){n.setState({openFileUploadPreviewDialog:!1})})),e(h(n),"handleShare",(function(e,r,t){n.setState({openFileUploadPreviewDialog:!1},(function(){n.props.handleShare&&n.props.handleShare(e,r,t)}))})),n.state={currentUpload:null,s3FileUrl:null,s3FileName:null,s3FileSize:null,uploadingFileToS3:!1,openFileUploadPreviewDialog:!1},n.fileInput=u(),n}return n(m,[{key:"clearUpload",value:function(){var e=this.state.currentUpload;e&&e.uploader&&e.uploader.abortUpload()}},{key:"renderUploadButton",value:function(){var e=this.props.isNative?S:O;return s("label",{htmlFor:this.props.inputId,children:[a("input",{ref:this.fileInput,id:this.props.inputId,type:"file",disabled:this.props.disabled,onChange:this.uploadFile,style:{display:"none"}}),a(v,{"data-testid":"".concat("fileUpload","_attachFileButton"),"aria-label":"File Upload",disabled:this.props.disabled,component:this.props.disabled?"button":"span",className:this.props.fileUploadIconClassName,disableRipple:this.props.disableRipple,children:a(e,{htmlColor:this.props.disabled?"":this.props.nativeColor})})]})}},{key:"render",value:function(){return s(p,{children:[this.state.uploadingFileToS3?a(y,{"data-testid":"generic_uploadProgress",classes:{root:this.props.classes.progressRoot},size:20}):this.renderUploadButton(),this.state.openFileUploadPreviewDialog&&a(P,{open:this.state.openFileUploadPreviewDialog,fileUrl:this.state.s3FileUrl,fileName:this.state.s3FileName,fileSize:this.state.s3FileSize,handleShare:this.handleShare,handleClose:this.handleCloseFileUploadPreviewDialog,additionalFields:this.props.additionalFields,requiredFields:this.props.requiredFields,message:this.props.message})]})}}]),m}();C.propTypes={nativeColor:f.string,disabled:f.bool,handleShare:f.func,inputId:f.string,openPreviewDialogOnUpload:f.bool,onFinish:f.func,onError:f.func,classes:f.shape({}).isRequired,isNative:f.bool.isRequired,fileUploadIconClassName:f.string,additionalFields:f.arrayOf(f.node),requiredFields:f.arrayOf(f.string),message:f.string,disableRipple:f.bool},C.defaultProps={nativeColor:"black",disabled:!1,fileUploadIconClassName:void 0,handleShare:void 0,additionalFields:[],requiredFields:[],message:void 0,inputId:"icon-button-file",disableRipple:!1,openPreviewDialogOnUpload:!0,onFinish:void 0,onError:void 0,isNative:l};var I=m({progressRoot:{margin:14}})(C);export default I;
