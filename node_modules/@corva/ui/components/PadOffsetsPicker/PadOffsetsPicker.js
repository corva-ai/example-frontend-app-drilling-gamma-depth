import e from"@babel/runtime/helpers/defineProperty";import t from"@babel/runtime/helpers/toConsumableArray";import{isEmpty as n,get as r}from"lodash";import{jsxs as a,jsx as i}from"react/jsx-runtime";import{makeStyles as c,Fab as s,Dialog as l,DialogTitle as o,DialogContent as d,FormControl as u,InputLabel as f,Select as p,MenuItem as m,Checkbox as h,ListItemText as S,DialogActions as g,Button as E}from"@material-ui/core";import{useMemo as I,useEffect as b}from"react";import{getPads as C}from"../../clients/jsonApi/index.js";import _ from"prop-types";import{Add as D}from"@material-ui/icons";import O from"jsona";import P from"use-tiny-state-machine";function y(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function W(t){for(var n=1;n<arguments.length;n++){var r=null!=arguments[n]?arguments[n]:{};n%2?y(Object(r),!0).forEach((function(n){e(t,n,r[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):y(Object(r)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))}))}return t}var v=new O,w=c({fabSmallBtn:{width:24,height:24,minHeight:24,margin:"0 6px 0 1px"},fabSmallBtnIcon:{width:20,height:20},dialogPaper:{width:"75%",maxWidth:420}});var L={id:"requests",initial:"idle",context:{padsData:[],wellsData:[],lastStage:[],error:null,companyId:0},states:{idle:{on:{FETCH_PADS:{target:"pending",action:function(e){var t=e.dispatch,a=e.context;C({fields:["pad.name","pad.wells"],sort:"name",per_page:1e3,company:a.companyId}).then((function(e){return v.deserialize(e)})).then((function(e){return e.filter((function(e){return!n(r(e,"wells"))}))})).then((function(e){return t("PADS_REQUEST_SUCCESS",e)})).catch((function(e){return t("FAILURE",e)}))}}}},pending:{on:{PADS_REQUEST_SUCCESS:{target:"success",beforeStateChange:function(e,t){return(0,e.updateContext)((function(e){return W(W({},e),{},{padsData:t})}))}},FAILURE:{target:"failure",beforeStateChange:function(e,t){throw new Error(t.message)}}}},success:{on:{FETCH_WELLS:{target:"success",action:function(e,t){(0,e.dispatch)("WELLS_REQUEST_SUCCESS",t.reduce((function(e,t){return e.concat(t.wells)}),[]))}},WELLS_REQUEST_SUCCESS:{target:"success",beforeStateChange:function(e,t){return(0,e.updateContext)((function(e){return W(W({},e),{},{wellsData:t})}))}}}}}},x={id:"dialog",initial:"closed",context:{selectedPadIds:[],selectedWellIds:[]},states:{closed:{on:{OPEN_DIALOG:{target:"open",beforeStateChange:function(e,r){var a=e.updateContext,i=r.currentWellIds,c=r.padsData,s=[];return n(i)||c.forEach((function(e){e.wells.forEach((function(t){i.includes(t.asset_id)&&!s.includes(e.id)&&s.push(e.id)}))})),a((function(e){return W(W({},e),{},{selectedPadIds:[].concat(s),selectedWellIds:t(i)})}))}}}},open:{on:{CLOSE_DIALOG:{target:"closed",beforeStateChange:function(e){return(0,e.updateContext)((function(e){return W(W({},e),{},{selectedPadIds:[],selectedWellIds:[]})}))}},SET_PAD_ID:{target:"open",beforeStateChange:function(e,t){var r=e.updateContext,a=t.selectedPadIds,i=t.currentWellIds,c=t.padsData,s=[];return n(i)||c.forEach((function(e){e.wells.forEach((function(t){a.includes(e.id)&&i.includes(t.asset_id)&&s.push(t.asset_id)}))})),r((function(e){return W(W({},e),{},{selectedPadIds:a,selectedWellIds:[].concat(s)})}))}},SET_WELL_ID:{target:"open",beforeStateChange:function(e,t){return(0,e.updateContext)((function(e){return W(W({},e),{},{selectedWellIds:t})}))}}}}}},j=function(e){var r=e.onSave,c=e.currentOffsetSetting,C=e.assets,_=e.companyId,O=w(),y=P(L),W=y.state,v=y.dispatch,j=y.context,A=P(x),T=A.state,k=A.dispatch,R=A.context,U=I((function(){return n(c)&&!n(C)?C.map((function(e){return e.asset_id})):c.map((function(e){return e.selectedWellId}))}),[c,C]),F=function(){return k("CLOSE_DIALOG")},q=R.selectedPadIds,B=R.selectedWellIds;return b((function(){j.companyId=_,v("FETCH_PADS")}),[]),b((function(){if(!n(q)){var e=j.padsData.filter((function(e){return q.includes(e.id)}));v("FETCH_WELLS",e)}}),[q]),a("div",{children:[i(s,{size:"small",color:"primary",classes:{sizeSmall:O.fabSmallBtn},onClick:function(){return k("OPEN_DIALOG",{currentWellIds:U,padsData:j.padsData})},disabled:"success"!==W,children:i(D,{className:O.fabSmallBtnIcon})}),"success"===W&&a(l,{open:"open"===T,onBackdropClick:F,classes:{paper:O.dialogPaper},children:[i(o,{children:"Offset Wells"}),a(d,{children:[a(u,{margin:"normal",fullWidth:!0,required:!0,children:[i(f,{htmlFor:"pad-select",shrink:!n(q),children:"Pad"}),i(p,{multiple:!0,inputProps:{name:"pads",id:"pad-select"},value:q,onChange:function(e){return k("SET_PAD_ID",{selectedPadIds:e.target.value,currentWellIds:U,padsData:j.padsData})},renderValue:function(e){return"".concat(e.length," selected")},children:j.padsData.map((function(e){return a(m,{value:e.id,children:[i(h,{checked:q.includes(e.id)}),i(S,{primary:e.name})]},e.id)}))})]}),a(u,{margin:"normal",disabled:n(q),fullWidth:!0,required:!0,children:[i(f,{htmlFor:"wells",shrink:!n(B),children:"Well"}),i(p,{multiple:!0,inputProps:{name:"wells",id:"well-select"},value:B,onChange:function(e){return k("SET_WELL_ID",e.target.value)},renderValue:function(e){return"".concat(e.length," selected")},children:j.wellsData.map((function(e){var t=U.includes(e.asset_id);return a(m,{value:e.asset_id,disabled:t,children:[i(h,{checked:B.includes(e.asset_id)}),i(S,{primary:e.name})]},e.id)}))})]})]}),a(g,{children:[i(E,{onClick:F,children:"Cancel"}),i(E,{variant:"contained",color:"primary",disabled:n(B),onClick:function(){var e=j.wellsData.filter((function(e){return B.includes(e.asset_id)})).map((function(e){return{selectedWellId:Number(e.asset_id),selectedWellName:e.name,selectedWellStatus:e.status,selectedStages:[],stages:{}}})),n=c.filter((function(t){return!e.find((function(e){return e.selectedWellId===t.selectedWellId}))}));n=[].concat(t(n),t(e)),F(),r(n)},children:"Save"})]})]})]})};j.propTypes={currentOffsetSetting:_.arrayOf(_.shape({})).isRequired,onSave:_.func.isRequired,companyId:_.string.isRequired,assets:_.arrayOf(_.shape({})).isRequired};export default j;
