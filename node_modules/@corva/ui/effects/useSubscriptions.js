import r from"@babel/runtime/helpers/defineProperty";import{castArray as t,differenceBy as e,omit as n,merge as u,concat as a,mapValues as i}from"lodash";import o from"@babel/runtime/helpers/slicedToArray";import c from"@babel/runtime/regenerator";import s from"@babel/runtime/helpers/asyncToGenerator";import{useState as p,useRef as f,useMemo as l,useEffect as m}from"react";import{parse as b}from"querystring";import d from"uuid/v1";import{getDCAppKey as y}from"../clients/utils.js";import{getAppStorage as v,getDataAppStorage as h,getDataAppStorageAggregate as O}from"../clients/jsonApi/index.js";import{getSubscriptionId as w}from"../clients/subscriptions.js";function g(r,t){var e=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(r,t).enumerable}))),e.push.apply(e,n)}return e}function j(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?g(Object(n),!0).forEach((function(e){r(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):g(Object(n)).forEach((function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(n,r))}))}return t}function I(r,t,e){var n=w(r,t);return j(j({},r),{},{hookId:t,subId:n,appInstanceId:n,app_key:e})}function k(r,t){return x.apply(this,arguments)}function x(){return(x=s(c.mark((function r(t,e){var n,u,a;return c.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return n=e.timeQuery,u=e.appKey,a=t.map(function(){var r=s(c.mark((function r(t){var e,a,i,o,s,p,f,l,m;return c.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(e=t.provider,a=t.collection,i=t.assetId,o=t.subscribeOnly,s=t.params,!o){r.next=3;break}return r.abrupt("return",null);case 3:return p=s.query,f=n?"{timestamp#lte#".concat(n.timestamp.$lte):"",l=p&&f?"AND":"",m="".concat(p).concat(l).concat(f),r.prev=7,r.next=10,v(e,a,i,j(j(j({},s),m?{query:m}:{}),{},{appKey:u}));case 10:return r.abrupt("return",r.sent);case 13:return r.prev=13,r.t0=r.catch(7),r.abrupt("return",[]);case 16:case"end":return r.stop()}}),r,null,[[7,13]])})));return function(t){return r.apply(this,arguments)}}()),r.abrupt("return",Promise.all(a));case 3:case"end":return r.stop()}}),r)})))).apply(this,arguments)}function P(r,t){return E.apply(this,arguments)}function E(){return(E=s(c.mark((function r(t,e){var n,a,o;return c.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return n=e.timeQuery,a=e.appKey,o=t.map(function(){var r=s(c.mark((function r(t){var e,o,s,p,f,l,m,b,d,y,v,w;return c.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(e=t.provider,o=t.collection,s=t.assetId,p=t.subscribeOnly,f=t.params,l=void 0===f?{}:f,!p){r.next=3;break}return r.abrupt("return",null);case 3:if(!l.aggregate){r.next=5;break}return r.abrupt("return",O(e,o,j({},i(l.aggregate,JSON.stringify))));case 5:return m=JSON.stringify(u({asset_id:s},l.query,n)),b=l.limit,d=void 0===b?1:b,y=l.sort,v=void 0===y?'{"timestamp": 1}':y,r.prev=7,w=j(j({},l),{},{limit:d,sort:v,query:m,appKey:a}),r.next=11,h(e,o,w);case 11:return r.abrupt("return",r.sent);case 14:return r.prev=14,r.t0=r.catch(7),r.abrupt("return",[]);case 17:case"end":return r.stop()}}),r,null,[[7,14]])})));return function(t){return r.apply(this,arguments)}}()),r.abrupt("return",Promise.all(o));case 3:case"end":return r.stop()}}),r)})))).apply(this,arguments)}function D(u){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},c=i.timestamp,s=i.isOldApiUsed,v=p({}),h=o(v,2),O=h[0],w=h[1],g=f();g.current||(g.current=d());var x=window[Symbol.for("socket")],E=x.subscribe,D=x.unsubscribe,S=x.socket,q=l((function(){return y()}),[]),A=f([]),K=t(u).map((function(r){return I(r,g.current,q)})),N=K.map((function(r){return r.subId})).join(),Q=l((function(){if(c)return{timestamp:{$lte:c}};var r=b(window.location.search).time;return r?{timestamp:{$lte:new Date(r)/1e3}}:null}),[window.location.search,c]);return m((function(){var t=function(t){t.hookId===g.current&&w((function(e){var n=t.data;return t.subId in e&&!t.subscribeOnly&&(n=a(e[t.subId],t.data)),t.params&&t.params.limit&&(n=n.slice(-t.params.limit)),j(j({},e),{},r({},t.subId,n))}))};return S&&S.on("data",t),function(){return S&&S.off("data",t)}}),[]),m((function(){A.current.forEach(D),A.current=[]}),[Q]),m((function(){var r=A.current,t=e(K,r,"subId"),u=e(r,K,"subId");t.forEach((function(r){Q&&!r.alwaysSubscribe||E(r)})),u.forEach(D),A.current=K,(s?k:P)(t,{timeQuery:Q,appKey:q,isOldApiUsed:s}).then((function(r){return w((function(e){var a=n(e,u.map((function(r){return r.subId})));return t.forEach((function(t,e){null!==r[e]&&(a[t.subId]=r[e])})),a}))}))}),[N,Q]),m((function(){return function(){return A.current.forEach(D)}}),[]),l((function(){return K.map((function(r){var t=r.subId;return{loading:!(t in O),data:O[t]}}))}),[O,N])}export default D;
