import e from"@babel/runtime/helpers/defineProperty";import{flowRight as t}from"lodash";import r from"@babel/runtime/regenerator";import i from"@babel/runtime/helpers/asyncToGenerator";import{isNativeDetected as n}from"../../../../utils/mobileDetect.js";import{jsxs as a,jsx as s}from"react/jsx-runtime";import o from"@material-ui/icons/Close";import{memo as c,useMemo as m}from"react";import{closeLastAnnotation as u}from"../../../../clients/jsonApi/index.js";import{number as d,shape as l,arrayOf as p,string as f,bool as h,func as v}from"prop-types";import b from"classnames";import{withStyles as y}from"@material-ui/core/styles";import N from"@material-ui/core/Typography";import A from"../../../Avatar/index.js";import R from"../../../UserCardPopover.js";import{formatMentionText as g}from"../../../UserMention/utils/index.js";import x from"@material-ui/core/Paper";import q,{isWidthUp as _}from"@material-ui/core/withWidth";import U from"@material-ui/icons/Comment";import C from"./style.css.js";var j="lastAnnotation",L=function(e){var t=e.user,r=e.currentUser,i=e.isNative,n=e.className,a=e.size,o=s(A,{displayName:"".concat(t.first_name," ").concat(t.last_name),imgSrc:t.profile_photo,size:a,className:n});return i?o:s(R,{user:t,currentUser:r,children:o})},T=function(t){var r=t.commentsCount,i=t.commentUsers,n=t.isSmallScreen,o=t.isNative,c=t.currentUser,m=t.classes;return r?a("div",{className:C.cTopAnnotationAdditionalReactions,children:[s(U,{className:m.commentIcon}),!n&&a(N,{variant:"body2","data-testid":"".concat(j,"_comments"),noWrap:!0,className:m.commentText,component:"div",children:["Comments ",r]}),s("div",{className:C.cTopAnnotationAdditionalReactionsList,children:i.map((function(t,r){var i=t.attributes;return s(L,{user:i,currentUser:c,isNative:o,className:b(m.avatar,e({},m.avatarInList,0!==r)),size:25},i.id)}))})]}):null},w=function(e){var t,n=e.isNative,c=e.appId,d=e.annotation,l=e.openAnnotationsList,p=e.currentUser,f=e.updateCurrentDashboardAppLastAnnotation,h=e.width,v=e.classes,b=d.data,y=d.included,A=y.find((function(e){var t=e.id,r=e.type;return t===b.relationships.user.data.id&&"user"===r})),R=m((function(){return b.relationships.mentioned_users.data.map((function(e){var t=e.id;return y.find((function(e){return e.id===t}))}))}),[b.relationships.mentioned_users.data,y]),q=m((function(){return b.relationships.comment_users.data.map((function(e){var t=e.id;return y.find((function(e){return e.id===t}))}))}),[b.relationships.comment_users.data,y]),U=!_("sm",h),w=(t=i(r.mark((function e(t){var i;return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t.stopPropagation(),e.prev=1,e.next=4,u(b.id);case 4:i=e.sent,f(b.id,c,i),e.next=11;break;case 8:e.prev=8,e.t0=e.catch(1),console.error(e.t0);case 11:case"end":return e.stop()}}),e,null,[[1,8]])}))),function(e){return t.apply(this,arguments)});return a(x,{"data-testid":"".concat(j,"_lastAnnotation"),className:v.container,onClick:l,children:[a("div",{className:C.cTopAnnotationMain,children:[s(L,{user:A.attributes,currentUser:p,isNative:n,className:v.avatar,size:38}),s(N,{variant:"body2","data-testid":"".concat(j,"_message"),noWrap:!0,className:v.body,children:g(b.attributes.body,R,n,null,p)})]}),a("div",{className:C.cTopAnnotationAdditional,children:[s(T,{commentsCount:b.attributes.comments_count,commentUsers:q,classes:v,isSmallScreen:U,currentUser:p}),s(o,{"data-testid":"".concat(j,"_closeButton"),fontSize:"small",className:v.closeButton,onClick:w})]})]})};w.propTypes={appId:d.isRequired,annotation:l({included:p(l({})).isRequired,data:l({relationships:l({user:l({data:l({id:f.isRequired}).isRequired}).isRequired,mentioned_users:l({data:p(l()).isRequired}).isRequired}).isRequired,attributes:l({body:f.isRequired,created_at:f.isRequired})}).isRequired}).isRequired,classes:l({}).isRequired,isNative:h,width:f.isRequired,openAnnotationsList:v.isRequired,updateCurrentDashboardAppLastAnnotation:v,currentUser:l({})},w.defaultProps={isNative:n,updateCurrentDashboardAppLastAnnotation:function(){},currentUser:{}};var I=t([y((function(e){return{container:{height:56,margin:"10px 0",padding:"0 20px",display:"flex",alignItems:"center",justifyContent:"space-between",flex:"auto 1",width:"100%",cursor:"pointer"},body:{margin:"0 16px ",minWidth:100},avatar:{border:"1px solid #909090"},commentIcon:{marginRight:16,color:e.palette.grey[500]},commentText:{marginRight:16,color:e.palette.grey[500]},closeButton:{color:e.palette.grey[500]},avatarInList:{marginLeft:-4}}})),q()])(c(w));export default I;
