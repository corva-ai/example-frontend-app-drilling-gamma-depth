import t from"@babel/runtime/helpers/defineProperty";import{get as e}from"lodash";import n from"@babel/runtime/helpers/classCallCheck";import o from"@babel/runtime/regenerator";import i from"@babel/runtime/helpers/asyncToGenerator";import r from"@material-ui/core/colors/grey";import a from"../../utils/main.js";import{isNativeDetected as s}from"../../utils/mobileDetect.js";import{notifyCommentEdit as l,notifyCommentPost as c}from"../../utils/nativeMessages.js";import p from"@babel/runtime/helpers/createClass";import{jsxs as m,jsx as d}from"react/jsx-runtime";import{Paper as u,TextField as h,InputAdornment as f,Tooltip as C,Typography as g,IconButton as b}from"@material-ui/core";import{PureComponent as v}from"react";import{patchFeedItemComment as x}from"../../clients/jsonApi/index.js";import I from"lodash/noop";import y from"prop-types";import E from"classnames";import{withStyles as F}from"@material-ui/core/styles";import S from"@babel/runtime/helpers/assertThisInitialized";import U from"@babel/runtime/helpers/inherits";import k from"@babel/runtime/helpers/possibleConstructorReturn";import N from"@babel/runtime/helpers/getPrototypeOf";import A from"../Avatar/index.js";import{isSuggestionsListOpened as M}from"../UserMention/utils/index.js";import R from"../UserMention/index.js";import j from"../EmojiIconButton.js";import w from"../FailedFileUploading.js";import L from"../FileUploadIconButton.js";import T from"../FilePreview/index.js";import P from"../Icons/SendIcon.js";import D from"./styles.css.js";function B(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}();return function(){var n,o=N(t);if(e){var i=N(this).constructor;n=Reflect.construct(o,arguments,i)}else n=o.apply(this,arguments);return k(this,n)}}var z={chatAvatarWrapper:{display:"inline-block",verticalAlign:"top",position:"absolute",left:-18},commentTextFieldContainer:{position:"relative",margin:"0"},commentTextFieldContainerSpaceAround:{position:"relative",margin:"20px 10px"}},_=function(s){U(y,v);var I=B(y);function y(e){var r,a,s;return n(this,y),r=I.call(this,e),t(S(r),"handleSelectEmoji",(function(t){return r.setState((function(e){var n=e.comment;return{comment:"".concat(n).concat(t.native)}}))})),t(S(r),"postComment",(a=i(o.mark((function t(e){var n;return o.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,r.props.postComment(e);case 3:n=t.sent,t.next=9;break;case 6:t.prev=6,t.t0=t.catch(0),console.error(t.t0.message);case 9:return t.abrupt("return",n);case 10:case"end":return t.stop()}}),t,null,[[0,6]])}))),function(t){return a.apply(this,arguments)})),t(S(r),"patchComment",(s=i(o.mark((function t(e){var n,i,a,s;return o.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=r.props,i=n.editFeedItemId,a=n.editCommentId,t.prev=1,t.next=4,x(i,a,e);case 4:s=t.sent,t.next=10;break;case 7:t.prev=7,t.t0=t.catch(1),console.error(t.t0.message);case 10:return t.abrupt("return",s);case 11:case"end":return t.stop()}}),t,null,[[1,7]])}))),function(t){return s.apply(this,arguments)})),t(S(r),"clearCommentField",(function(t){r.setState({comment:"",attachmentUrl:null,attachmentName:null,attachmentSize:null},(function(){r.focusOnRef(),t&&"function"==typeof t&&t()}))})),t(S(r),"handleKeyDown",(function(t){var e=t.key;"Escape"===e&&r.props.exitEditMode(),"Enter"===e&&(M()||(t.preventDefault(),r.handleSendComment()))})),t(S(r),"handleAttachmentLoadingError",(function(t){r.setState({attachmentUrl:null,attachmentName:null,attachmentSize:null,attachmentLoadingError:t})})),t(S(r),"handleFileUpload",(function(t,e,n){r.setState({attachmentUrl:t,attachmentName:e,attachmentSize:n,attachmentLoadingError:null})})),t(S(r),"handleNativeFileUpload",(function(){var t=r.state.comment;r.isEditMode?(l(t),r.clearCommentField(r.props.exitEditMode)):(c(t),r.clearCommentField())})),t(S(r),"handleFileDelete",(function(){return r.setState({attachmentUrl:null,attachmentName:null,attachmentSize:null})})),t(S(r),"handleSendComment",i(o.mark((function t(){var e,n,i;return o.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if((e=r.state.comment?r.state.comment.trim():null)||r.state.attachmentUrl){t.next=3;break}return t.abrupt("return");case 3:if(n={comment:{body:e,attachment:{url:r.state.attachmentUrl,size:r.state.attachmentSize}}},!r.isEditMode){t.next=16;break}return r.props.setIsEditting(!0),t.next=8,r.patchComment(n);case 8:return i=t.sent,t.next=11,r.props.patchCommentCallback(i);case 11:r.props.setIsEditting(!1),r.clearCommentField(),r.props.exitEditMode(),t.next=24;break;case 16:return r.props.setIsPosting(!0),t.next=19,r.postComment(n);case 19:return i=t.sent,t.next=22,r.props.postCommentCallback(i);case 22:r.props.setIsPosting(!1),r.clearCommentField();case 24:case"end":return t.stop()}}),t)})))),t(S(r),"handleCloseEditClick",(function(){r.setState({comment:""}),r.props.exitEditMode()})),r.state={comment:"",attachmentUrl:null,attachmentName:null,attachmentSize:null,attachmentLoadingError:null},r}return p(y,[{key:"componentDidMount",value:function(){this.isEditMode&&this.setInitialCommentValue()}},{key:"componentDidUpdate",value:function(t){(this.isEditMode&&!t.editFeedItemId||this.props.editCommentId&&this.props.editCommentId!==t.editCommentId)&&this.setInitialCommentValue()}},{key:"setInitialCommentValue",value:function(){var t=this.props.editAttachment?this.props.editAttachment.url:null;this.setState({comment:this.props.editComment,attachmentUrl:t,attachmentName:t?a.getFileNameWithExtensionFromPath(t):null,attachmentSize:this.props.editAttachment?this.props.editAttachment.url:null})}},{key:"focusOnRef",value:function(){this.props.inputRef&&this.props.inputRef.current.focus()}},{key:"render",value:function(){var t=this,n=this.props,o=n.classes,i=n.currentUser,a="".concat(e(i,["attributes","first_name"])," ").concat(e(i,["attributes","last_name"]));return m("div",{style:this.props.spaceAround?z.commentTextFieldContainerSpaceAround:z.commentTextFieldContainer,children:[d("div",{style:z.chatAvatarWrapper,children:d(A,{displayName:a,imgSrc:this.props.currentUser&&this.props.currentUser.profile_photo})}),d(u,{className:this.props.classes.paperRoot,children:d(h,{"data-testid":"".concat("commentInput","_input"),placeholder:"Add Comment...",FormHelperTextProps:{component:"div",margin:"dense"},InputProps:{inputComponent:R,inputProps:{onChange:function(e){return t.setState({comment:e})},singleLine:!0,value:this.state.comment||"",inputRef:this.props.inputRef,withLightTheme:!1,onMount:this.props.onMount,companyId:this.props.companyId,autoFocus:this.props.autoFocus,disabled:this.props.disabled},endAdornment:!this.props.isNative&&m(f,{position:"end",className:this.props.classes.iconsContainer,children:[!this.state.attachmentUrl&&d(C,{title:"Attach File",placement:"bottom",classes:{tooltip:o.iconTooltip},children:d("div",{className:E(D.cCommentInputIconContainer,D.cCommentInputIconUpload),children:d(L,{openPreviewDialogOnUpload:!1,disableRipple:!0,onFinish:this.handleFileUpload,onError:this.handleAttachmentLoadingError,fileUploadIconClassName:this.props.classes.additionalActionButton,htmlColor:r[400],inputId:"comment-attachment-".concat(this.props.editCommentId)})})}),d(C,{title:"Add Emoji",placement:"bottom",classes:{tooltip:o.iconTooltip},children:d("div",{className:D.cCommentInputIconContainer,children:d(j,{"data-testid":"".concat("commentInput","_emojiButton"),handleSelectEmoji:this.handleSelectEmoji,emojiIconClassName:this.props.classes.additionalActionButton,htmlColor:r[400],disableRipple:!0})})})]}),disableUnderline:!0,classes:{root:this.props.classes.inputRoot,input:this.props.classes.inputEl}},className:this.props.classes.input,onKeyDown:this.handleKeyDown})}),this.state.attachmentLoadingError&&d(w,{errorMessage:this.state.attachmentLoadingError,className:this.props.classes.fileUploadingError}),this.state.attachmentUrl&&d(T,{fileName:this.state.attachmentName,fileUrl:this.state.attachmentUrl,handleFileDelete:this.handleFileDelete,classes:this.props.classes}),m("div",{className:D.cCommentInputSendContainer,children:[d("div",{className:D.cCommentInputSendContainerCancel,children:this.isEditMode&&d(g,{variant:"caption",className:E(this.props.classes.inputMain,this.props.classes.cancelText,this.props.classes.highlightedLabel),component:"div",gutterBottom:!0,onClick:this.props.exitEditMode,children:"Cancel"})}),m("div",{className:D.cCommentInputSendContainerSend,children:[m(g,{variant:"caption",className:E(this.props.classes.inputMain,this.props.classes.inputHelper),component:"div",gutterBottom:!0,children:["Press ",d(g,{variant:"caption",color:"primary",className:E(this.props.classes.inputMain,this.props.classes.highlightedLabel),children:"Enter"})," to send"]}),d(b,{"data-testid":"".concat("commentInput","_sendButton"),onClick:this.handleSendComment,children:d(P,{})})]})]})]})}},{key:"isEditMode",get:function(){return!!this.props.editFeedItemId}}]),y}();_.propTypes={inputRef:y.shape({}),editFeedItemId:y.number,editCommentId:y.number,editComment:y.string,editAttachment:y.shape({}),spaceAround:y.bool,postComment:y.func.isRequired,postCommentCallback:y.func,patchCommentCallback:y.func,exitEditMode:y.func,setIsPosting:y.func,setIsEditting:y.func,onMount:y.func,autoFocus:y.bool,disabled:y.bool,classes:y.shape({}).isRequired,currentUser:y.shape(),isNative:y.bool,companyId:y.number},_.defaultProps={inputRef:null,editFeedItemId:null,editCommentId:null,editComment:null,editAttachment:{},spaceAround:!1,setIsPosting:I,setIsEditting:I,onMount:I,autoFocus:void 0,disabled:!1,patchCommentCallback:I,postCommentCallback:I,exitEditMode:I,companyId:null,currentUser:{},isNative:s};var H=F((function(t){return{paperRoot:{width:"calc(100% - 28px)",marginLeft:25,display:"inline-block",height:35,border:"0","&:focus-within":{boxShadow:"inset 0 0 0 2px ".concat(t.palette.primary.main)},boxShadow:"none"},input:{paddingLeft:5,width:"100%"},inputRoot:{height:35,paddingRight:"10px",lineHeight:"29px",paddingLeft:"10px"},inputEl:{padding:"0 0 0 6px",height:"100%"},additionalActionButton:{padding:"5px","&:hover":{backgroundColor:"transparent"}},nativeActionButton:{margin:"5px 10px",cursor:"pointer"},fileUploadingError:{marginTop:10,marginLeft:24},inputMain:{marginBottom:0,fontSize:".7rem",color:t.palette.grey[700]},inputHelper:{display:"flex",paddingRight:5},cancelText:{cursor:"pointer"},highlightedLabel:{color:t.palette.primary.main},iconsContainer:{marginRight:"8px"},iconTooltip:{marginTop:"3px"}}}))(_);export default H;
