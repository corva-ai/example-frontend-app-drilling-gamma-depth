import"@babel/runtime/helpers/defineProperty";import{get as r}from"lodash";import{updateUserUnits as t}from"../../../utils/convert.js";import e from"@babel/runtime/helpers/slicedToArray";import n from"@babel/runtime/regenerator";import o from"@babel/runtime/helpers/asyncToGenerator";import{useState as s,useRef as i,useEffect as a}from"react";import{setAuthToken as u,removeAuthToken as c,getAuthToken as p}from"../../../clients/clientStorage/index.js";import{post as l}from"../../../clients/api/apiCore.js";import"../../../clients/constants.js";import{getCurrentUser as m}from"../../../clients/jsonApi/index.js";import"../../../clients/subscriptions.js";import"uuid";import{LOGIN_ROUTE_REG_EXP as f}from"../../constants/index.js";import h from"../../../clients/auth0/index.js";var d=function(r){return fetch("/dotenv",{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)})};function v(v){var y=s(null),b=e(y,2),j=b[0],x=b[1],g=s(!0),T=e(g,2),w=T[0],k=T[1],A=s(null),_=e(A,2),U=_[0],C=_[1],H=i();function N(){return O.apply(this,arguments)}function O(){return(O=o(n.mark((function e(){var o;return n.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,k(!0),e.next=4,m();case 4:o=e.sent,x(o),t({userUnits:o.unit_system,companyUnits:r(o,"company.unit_system")}),d({AUTH_TOKEN:p()}),e.next=15;break;case 10:e.prev=10,e.t0=e.catch(0),c(),v.push("/login"),console.error(e.t0);case 15:k(!1);case 16:case"end":return e.stop()}}),e,null,[[0,10]])})))).apply(this,arguments)}H.current||(H.current=new h);var E,K=(E=o(n.mark((function r(t,e){var o;return n.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.prev=0,C(null),k(!0),r.next=5,l("/v1/user_token",{auth:t});case 5:o=r.sent,u(o.jwt),r.next=14;break;case 9:return r.prev=9,r.t0=r.catch(0),console.error(r.t0),k(!1),r.abrupt("return",C("Wrong user name or password"));case 14:N().then(e);case 15:case"end":return r.stop()}}),r,null,[[0,9]])}))),function(r,t){return E.apply(this,arguments)});return a((function(){var r;try{r=p()}catch(r){c()}var t=f.test(v.location.pathname);return!r&&t?k(!1):r?void N():(v.push("/login"),k(!1))}),[]),{user:j,loading:w,error:U,login:K,logout:function(){c(),d({AUTH_TOKEN:""}),v.push("/login")},auth0:H.current}}export default v;
